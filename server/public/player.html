<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <title>Joueur - La Bonne Paye</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body {
            font-family: system-ui, sans-serif;
            max-width: 720px;
            margin: 24px auto;
        }

        .card {
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 16px;
            margin-top: 12px;
        }

        #rollBtn {
            font-size: 16px;
            padding: 8px 12px;
        }

        .muted {
            color: #666;
            font-size: 13px;
        }

        .history {
            margin-top: 6px;
            padding: 8px;
            background: #f7f7f7;
            border-radius: 8px;
        }

        .history strong {
            display: inline-block;
            width: 160px;
        }

        .ok {
            color: #157347;
            font-weight: 600;
        }

        .warn {
            color: #b35300;
            font-weight: 600;
        }
    </style>
</head>

<body>
    <h1>Bienvenue joueur !</h1>

    <!-- Formulaire d'inscription -->
    <div id="formulaire" class="card">
        <label for="pseudo">Entrez votre pseudo :</label>
        <input type="text" id="pseudo" placeholder="Ex: Jules" />
        <button id="joinBtn">Rejoindre la partie</button>
        <p class="muted">Ton pseudo est mÃ©morisÃ© localement, mais l'inscription n'est plus automatique.</p>
    </div>

    <!-- Zone de jeu -->
    <div id="jeu" class="card" style="display:none;">
        <p>Bonjour <span id="nom"></span> !</p>
        <p>Tour : <span id="tour" class="warn">en attenteâ€¦</span></p>
        <p>Position actuelle : <span id="pos" class="ok">0</span></p>
        <button id="rollBtn" disabled>ðŸŽ² Lancer le dÃ©</button>

        <div class="history">
            <div><strong>Historique des cases :</strong> <span id="visited">â€”</span></div>
            <div class="muted">Format : 0 â†’ 5 â†’ 12 â†’ â€¦</div>
        </div>
    </div>

    <script>
        const socket = io();

        const elForm = document.getElementById('formulaire');
        const elJeu = document.getElementById('jeu');
        const elNom = document.getElementById('nom');
        const elTour = document.getElementById('tour');
        const elPos = document.getElementById('pos');
        const elVisited = document.getElementById('visited');
        const rollBtn = document.getElementById('rollBtn');

        // --- PrÃ©-remplissage mais PAS d'inscription auto ---
        const savedPseudo = localStorage.getItem('pseudo');
        if (savedPseudo) {
            document.getElementById('pseudo').value = savedPseudo; // juste remplir le champ
        }

        // Envoi du pseudo au serveur (inscription volontaire)
        document.getElementById('joinBtn').addEventListener('click', () => {
            const pseudo = document.getElementById('pseudo').value.trim();
            if (!pseudo) return alert("Veuillez entrer un pseudo !");
            localStorage.setItem('pseudo', pseudo);
            socket.emit('register-player', { pseudo });
        });

        // Confirmation d'enregistrement
        socket.on('player-registered', (pseudo) => {
            elForm.style.display = 'none';
            elJeu.style.display = 'block';
            elNom.textContent = pseudo;
        });

        // Refus d'inscription (pseudo dÃ©jÃ  pris, etc.)
        socket.on('register-denied', ({ reason }) => {
            alert(reason || "Inscription refusÃ©e.");
        });

        // Gestion du tour par tour
        socket.on('tour-actuel', ({ socketId, pseudo }) => {
            const estMonTour = socket.id === socketId;
            rollBtn.disabled = !estMonTour;
            elTour.textContent = estMonTour ? "c'est ton tour !" : `tour de ${pseudo}`;
            elTour.className = estMonTour ? 'ok' : 'warn';
        });

        // Historique & position via players-state
        socket.on('players-state', (players) => {
            const me = getMe(players);
            if (!me) return; // pas encore inscrit

            elPos.textContent = me.position ?? 0;
            elVisited.textContent = (Array.isArray(me.visited) && me.visited.length)
                ? me.visited.join(' â†’ ')
                : 'â€”';

            // Si on a un pseudo mÃ©morisÃ© et qu'on recharge, bascule l'UI si besoin
            if (savedPseudo && elJeu.style.display === 'none') {
                elForm.style.display = 'none';
                elJeu.style.display = 'block';
                elNom.textContent = savedPseudo;
            }
        });

        // Lancer de dÃ©
        rollBtn.addEventListener('click', () => {
            const dice = Math.floor(Math.random() * 6) + 1;
            socket.emit('dice-roll', { value: dice });
        });

        // Reset depuis le plateau
        socket.on('reset-client', () => {
            localStorage.removeItem('pseudo');
            elForm.style.display = 'block';
            elJeu.style.display = 'none';
            document.getElementById('pseudo').value = '';
            rollBtn.disabled = true;
            elVisited.textContent = 'â€”';
            elPos.textContent = '0';
            elTour.textContent = 'en attenteâ€¦';
            elTour.className = 'warn';
        });

        // --- Helpers ---
        function getMe(players) {
            // Essai 1 : par socketId (fiable)
            let me = players.find(p => p.socketId === socket.id);
            if (me) return me;

            // Essai 2 : par pseudo mÃ©morisÃ© (utile si socket.id a changÃ© avant la rÃ©ponse)
            const pseudo = localStorage.getItem('pseudo');
            if (!pseudo) return null;
            return players.find(p => p.pseudo === pseudo) || null;
        }
    </script>
</body>

</html>