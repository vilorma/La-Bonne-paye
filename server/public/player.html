<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <title>Joueur - La Bonne Paye</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body {
            font-family: system-ui, sans-serif;
            max-width: 720px;
            margin: 24px auto;
        }

        .card {
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 16px;
            margin-top: 12px;
        }

        #rollBtn {
            font-size: 16px;
            padding: 8px 12px;
        }

        .muted {
            color: #666;
            font-size: 13px;
        }

        .history {
            margin-top: 6px;
            padding: 8px;
            background: #f7f7f7;
            border-radius: 8px;
        }

        .history strong {
            display: inline-block;
            width: 160px;
        }

        .ok {
            color: #157347;
            font-weight: 600;
        }

        .warn {
            color: #b35300;
            font-weight: 600;
        }

        .error {
            color: #b00020;
            font-weight: 600;
        }
    </style>
</head>

<body>
    <h1>Joueur â€“ La Bonne Paye</h1>

    <!-- Formulaire d'inscription -->
    <div id="formulaire" class="card">
        <p id="counter" class="muted" style="margin:0 0 8px 0;">0 / 6 joueurs</p>
        <label for="pseudo">Entrez votre pseudo :</label>
        <input type="text" id="pseudo" placeholder="Ex: Jules" />
        <button id="joinBtn">Rejoindre la partie</button>
        <p class="muted">Limite : 6 joueurs. Pas de spectateurs.</p>
        <p id="errorMsg" class="error" style="display:none;"></p>
    </div>

    <!-- Zone de jeu (uniquement si inscrit) -->
    <div id="jeu" class="card" style="display:none;">
        <p>Bonjour <span id="nom"></span> !</p>
        <p>Tour : <span id="tour" class="warn">en attenteâ€¦</span></p>
        <p>Position actuelle : <span id="pos" class="ok">0</span></p>
        <button id="rollBtn" disabled>ðŸŽ² Lancer le dÃ©</button>

        <div class="history">
            <div><strong>Historique des cases :</strong> <span id="visited">â€”</span></div>
            <div class="muted">Format : 0 â†’ 5 â†’ 12 â†’ â€¦</div>
        </div>
    </div>

    <script>
        const socket = io();

        const elForm = document.getElementById('formulaire');
        const elJeu = document.getElementById('jeu');
        const elNom = document.getElementById('nom');
        const elTour = document.getElementById('tour');
        const elPos = document.getElementById('pos');
        const elVisited = document.getElementById('visited');
        const rollBtn = document.getElementById('rollBtn');
        const inputPseudo = document.getElementById('pseudo');
        const errorMsg = document.getElementById('errorMsg');
        const counterEl = document.getElementById('counter');

        // Champ pseudo VIDE Ã  l'ouverture (pas de localStorage)
        inputPseudo.value = '';

        // Inscription volontaire
        document.getElementById('joinBtn').addEventListener('click', () => {
            errorMsg.style.display = 'none';
            const pseudo = inputPseudo.value.trim();
            if (!pseudo) return alert("Veuillez entrer un pseudo !");
            socket.emit('register-player', { pseudo });
        });

        // Confirmation d'inscription
        socket.on('player-registered', (pseudo) => {
            elForm.style.display = 'none';
            elJeu.style.display = 'block';
            elNom.textContent = pseudo;
            // le bouton restera dÃ©sactivÃ© jusqu'Ã  'tour-actuel'
            rollBtn.disabled = true;
        });

        // Refus (partie pleine ou pseudo dÃ©jÃ  pris)
        socket.on('register-denied', ({ reason }) => {
            errorMsg.textContent = reason || "Inscription refusÃ©e.";
            errorMsg.style.display = 'block';
        });

        // Tour par tour
        socket.on('tour-actuel', ({ socketId, pseudo }) => {
            const estMonTour = socket.id === socketId;
            rollBtn.disabled = !estMonTour;
            elTour.textContent = estMonTour ? "c'est ton tour !" : `tour de ${pseudo}`;
            elTour.className = estMonTour ? 'ok' : 'warn';
        });

        // Normalisation du payload players-state
        function normalizePlayersState(payload) {
            if (Array.isArray(payload)) return { players: payload, count: payload.length, max: 6 };
            return {
                players: Array.isArray(payload.players) ? payload.players : [],
                count: Number(payload.count) || 0,
                max: Number(payload.max) || 6,
            };
        }

        // Ã‰tat du jeu (compteur + mon Ã©tat si inscrit)
        socket.on('players-state', (payload) => {
            const { players, count, max } = normalizePlayersState(payload);

            // compteur X / max dans le formulaire
            if (counterEl) counterEl.textContent = `${count} / ${max} joueurs`;

            // n'afficher le jeu que si je suis inscrit (socket.id connu du serveur)
            const me = players.find(p => p.socketId === socket.id) || null;
            if (!me) return;

            elPos.textContent = me.position ?? 0;
            elVisited.textContent = (Array.isArray(me.visited) && me.visited.length)
                ? me.visited.join(' â†’ ')
                : 'â€”';
        });

        // Lancer de dÃ© â€” dÃ©sactivation immÃ©diate pour Ã©viter les doubles clics
        rollBtn.addEventListener('click', () => {
            rollBtn.disabled = true;
            const dice = Math.floor(Math.random() * 6) + 1;
            socket.emit('dice-roll', { value: dice });
        });

        // Reset (depuis le plateau)
        socket.on('reset-client', () => {
            elForm.style.display = 'block';
            elJeu.style.display = 'none';
            inputPseudo.value = '';
            rollBtn.disabled = true;
            elVisited.textContent = 'â€”';
            elPos.textContent = '0';
            elTour.textContent = 'en attenteâ€¦';
            elTour.className = 'warn';
            errorMsg.style.display = 'none';
            if (counterEl) counterEl.textContent = `0 / 6 joueurs`;
        });
    </script>
</body>

</html>